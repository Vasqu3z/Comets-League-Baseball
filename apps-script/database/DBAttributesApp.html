<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
      margin: 0;
    }
    
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      max-width: 1400px;
      margin: 0 auto;
    }
    
    h2 {
      color: #1a73e8;
      margin-top: 0;
      text-align: center;
    }
    
    .admin-badge {
      background: #ea4335;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      margin-left: 10px;
    }
    
    .player-selector {
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    
    .player-selector label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
      color: #333;
    }
    
    .player-selector select {
      width: 100%;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    
    .button-group {
      margin: 20px 0;
      text-align: center;
    }
    
    button {
      background-color: #1a73e8;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
      margin: 0 5px;
    }
    
    button:hover {
      background-color: #1557b0;
    }
    
    button.secondary {
      background-color: #5f6368;
    }
    
    button.secondary:hover {
      background-color: #484a4d;
    }
    
    .results {
      margin-top: 30px;
    }
    
    .stat-section {
      margin: 25px 0;
      border-top: 3px solid #1a73e8;
      padding-top: 15px;
    }
    
    .stat-section h3 {
      color: #1a73e8;
      margin-bottom: 15px;
      font-size: 18px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      font-size: 12px;
    }
    
    th, td {
    padding: 10px 8px;
    text-align: center;
    border-bottom: 1px solid #ddd;
    font-size: 13px;
    width: auto;
    min-width: 80px;  /* Ensures minimum width for data columns */
    max-width: 120px; /* Prevents columns from getting too wide */
    }

    .stat-label {
    font-weight: bold;
    width: 180px;      /* Fixed width for label column */
    min-width: 180px;
    max-width: 180px;
    text-align: left;
    padding-left: 15px;
   }
    
    th {
      background-color: #f8f9fa;
      font-weight: bold;
      color: #333;
      position: sticky;
      top: 0;
    }
    
    tr:hover {
      background-color: #f8f9fa;
    }
    
    .loading {
      text-align: center;
      color: #666;
      padding: 20px;
    }
    
    .error {
      color: #d93025;
      padding: 10px;
      background: #fce8e6;
      border-radius: 4px;
      margin: 10px 0;
    }
    
    .player-header {
      text-align: center;
      font-weight: bold;
      background: #e8f0fe;
      padding: 12px;
      font-size: 13px;
    }
    
    .player-info {
      font-size: 11px;
      color: #5f6368;
      display: block;
      margin-top: 3px;
    }
    
    .subsection {
      background: #f8f9fa;
      padding: 5px 15px;
      font-weight: bold;
      font-size: 12px;
      color: #5f6368;
      text-align: left;
    }
    
    .overall-row {
      background-color: #fff3cd;
      font-weight: bold;
    }
    
    .best-value {
      background-color: #d4edda;
      font-weight: bold;
    }
    
    .category-overall {
      background-color: #e8f0fe;
      font-weight: bold;
      border-top: 2px solid #1a73e8;
    }
    
    .average-row {
      background-color: #fff3e0;
      font-weight: bold;
      font-style: italic;
      border-top: 2px solid #ff9800;
    }

    /* Edit Mode: Two-column layout */
    .edit-mode-table {
      display: flex;
      gap: 20px;
    }

    .edit-mode-table .player-column {
      flex: 1;
    }

    .edit-mode-table .league-column {
      flex: 1;
      opacity: 0.8;
    }

    .edit-mode-table table {
      width: 100%;
    }

    .league-header {
      background: #fff3e0 !important;
      color: #333;
      font-style: italic;
    }

    /* Edit Mode Styles */
    .edit-mode-indicator {
      background: #4CAF50;
      color: white;
      padding: 10px 20px;
      border-radius: 4px;
      text-align: center;
      margin: 15px 0;
      font-weight: bold;
    }

    .stat-input {
      width: 100%;
      padding: 6px;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      text-align: center;
      font-family: inherit;
    }

    .stat-input[type="number"] {
      max-width: 80px;
      margin: 0 auto;
      text-align: center;
      -moz-appearance: textfield; /* Firefox: remove spinner */
    }

    /* Remove spinner buttons from layout by default, add them back on hover */
    .stat-input[type="number"]::-webkit-outer-spin-button,
    .stat-input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .stat-input[type="number"]:hover::-webkit-outer-spin-button,
    .stat-input[type="number"]:hover::-webkit-inner-spin-button {
      -webkit-appearance: auto;
    }

    .stat-input:focus {
      outline: none;
      border-color: #1a73e8;
      background: #e8f0fe;
    }

    .stat-input.modified {
      border-color: #1a73e8;
      background: #e8f0fe;
    }

    .stat-input.invalid {
      border-color: #ea4335;
      background: #fce8e6;
    }

    .stat-input.valid {
      border-color: #34a853;
      background: #e6f4ea;
    }

    .validation-error {
      color: #ea4335;
      font-size: 10px;
      display: block;
      margin-top: 2px;
      text-align: center;
    }

    .edit-actions {
      position: sticky;
      bottom: 0;
      background: white;
      padding: 15px;
      border-top: 3px solid #1a73e8;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      margin-top: 20px;
      text-align: center;
    }

    .edit-actions button {
      margin: 0 10px;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: bold;
    }

    button.save-btn {
      background-color: #34a853;
    }

    button.save-btn:hover {
      background-color: #2d9548;
    }

    button.save-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    button.reset-btn {
      background-color: #fbbc04;
      color: #333;
    }

    button.reset-btn:hover {
      background-color: #f9ab00;
    }

    button.cancel-btn {
      background-color: #ea4335;
    }

    button.cancel-btn:hover {
      background-color: #d33828;
    }

    .edit-help {
      font-size: 12px;
      color: #5f6368;
      font-style: italic;
      margin-top: 10px;
    }

    .dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .dialog-overlay.show {
      display: flex;
    }

    .dialog-box {
      background: white;
      border-radius: 8px;
      padding: 25px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .dialog-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
      color: #333;
    }

    .dialog-message {
      font-size: 14px;
      color: #666;
      line-height: 1.5;
      margin-bottom: 20px;
    }

    .dialog-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .dialog-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .dialog-btn.primary {
      background: #1a73e8;
      color: white;
    }

    .dialog-btn.primary:hover {
      background: #1557b0;
    }

    .dialog-btn.secondary {
      background: #e0e0e0;
      color: #333;
    }

    .dialog-btn.secondary:hover {
      background: #d0d0d0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>‚öæ Player Attribute Comparison Tool <span class="admin-badge">ADMIN</span></h2>
    
    <div class="player-selector">
      <label for="player1">Player 1:</label>
      <select id="player1">
        <option value="">-- Select Player --</option>
      </select>
      
      <label for="player2">Player 2:</label>
      <select id="player2">
        <option value="">-- Select Player --</option>
      </select>
      
      <label for="player3">Player 3 (Optional):</label>
      <select id="player3">
        <option value="">-- Select Player --</option>
      </select>
      
      <label for="player4">Player 4 (Optional):</label>
      <select id="player4">
        <option value="">-- Select Player --</option>
      </select>
      
      <label for="player5">Player 5 (Optional):</label>
      <select id="player5">
        <option value="">-- Select Player --</option>
      </select>

      <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
        <label style="display: flex; align-items: center; cursor: pointer;">
          <input type="checkbox" id="excludeMiis" checked style="margin-right: 8px; cursor: pointer;">
          <span style="font-weight: normal;">Exclude Miis from averages</span>
        </label>
        <div style="font-size: 11px; color: #5f6368; margin-left: 24px; margin-top: 4px;">
          Miis are custom characters whose stats are balanced separately from the main cast
        </div>
      </div>
    </div>
    
    <div class="button-group">
      <button onclick="comparePlayers()">üìä Compare Players</button>
      <button class="secondary" onclick="clearSelection()">üîÑ Clear</button>
    </div>
    
    <div id="results" class="results"></div>
  </div>

  <script>
    // ===== GLOBAL STATE =====
    let allPlayers = [];
    let editMode = false;
    let currentEditingPlayer = null;
    let originalData = {};
    let modifiedFields = {};
    let leagueAverages = null;
    let classAverages = null;

    // ===== VALIDATION RULES =====
    const VALIDATION_RULES = {
      'Weight': { min: 0, max: 4, type: 'number' },
      'Curve': { min: 0, max: 200, type: 'number' },
      'Curveball Speed': { min: 70, max: 200, type: 'number' },
      'Fastball Speed': { min: 70, max: 200, type: 'number' },
      'Stamina': { min: 0, max: 100, type: 'number' },
      'Slap Hit Contact Size': { min: 10, max: 200, type: 'number' },
      'Charge Hit Contact Size': { min: 10, max: 200, type: 'number' },
      'Slap Hit Power': { min: 0, max: 150, type: 'number' },
      'Charge Hit Power': { min: 0, max: 150, type: 'number' },
      'Bunting': { min: 0, max: 200, type: 'number' },
      'Speed': { min: 0, max: 200, type: 'number' },
      'Throwing Speed': { min: 0, max: 200, type: 'number' },
      'Fielding': { min: 0, max: 200, type: 'number' },
      'Pitching Overall': { min: 0, max: 10, type: 'number' },
      'Batting Overall': { min: 0, max: 10, type: 'number' },
      'Fielding Overall': { min: 0, max: 10, type: 'number' },
      'Speed Overall': { min: 0, max: 10, type: 'number' },
      'Captain': { options: ['Yes', 'No'], type: 'dropdown' },
      'Hit Curve': { options: ['Enabled', 'Disabled'], type: 'dropdown' },
      'Pre-Charge': { options: ['Enabled', 'Disabled'], type: 'dropdown' },
      'Mii': { options: ['Yes', 'No'], type: 'dropdown' },
      'Throwing Side': { options: ['Right', 'Left'], type: 'dropdown' },
      'Batting Side': { options: ['Right', 'Left'], type: 'dropdown' },
      'Hitting Trajectory': { options: [], type: 'dropdown' }, // Will be populated dynamically
      'Star Pitch': { options: [
        'None', 'Breaking Ball', 'Fastball', 'Change-Up',  // Standard pitch types
        'Fireball', 'Tornado Ball', 'Barrel Ball', 'Banana Ball', 'Heart Ball', 'Flower Ball',
        'Phony Ball', 'Liar Ball', 'Rainbow Ball', 'Suction Ball', 'Killer Ball', 'Graffiti Ball'
      ], type: 'dropdown' },
      'Star Swing': { options: ['Standard', 'Fire Swing', 'Tornado Swing', 'Barrel Swing', 'Banana Swing', 'Heart Swing', 'Flower Swing', 'Phony Swing', 'Liar Swing', 'Egg Swing', 'Cannon Swing', 'Breath Swing', 'Graffiti Swing'], type: 'dropdown' },
      'Ability': { options: [
        // Fielding abilities (at top as requested)
        'None (Fielding)', 'Super Dive', 'Super Jump', 'Tongue Catch', 'Suction Catch',
        'Magical Catch', 'Piranha Catch', 'Hammer Throw', 'Keeper Catch', 'Clamber',
        'Ball Dash', 'Laser Beam', 'Quick Throw',
        // Baserunning abilities
        'None (Baserunning)', 'Scatter Dive', 'Ink Dive', 'Angry Attack',
        'Teleport', 'Spin Attack', 'Burrow', 'Enlarge'
      ], type: 'dropdown' },
      'Mii Color': { options: ['Red', 'Orange', 'Yellow', 'Light Green', 'Green', 'Blue', 'Light Blue', 'Pink', 'Purple', 'Brown', 'White', 'Black'], type: 'dropdown' }
    };

    // ===== INITIALIZATION =====
    window.onload = function() {
      // Disable all selects until data loads
      disableAllSelects();

      // Fetch trajectory types for validation
      google.script.run
        .withSuccessHandler(function(trajectoryTypes) {
          VALIDATION_RULES['Hitting Trajectory'].options = trajectoryTypes;
        })
        .withFailureHandler(function(error) {
          // Fall back to defaults if fetch fails
          VALIDATION_RULES['Hitting Trajectory'].options = ['Medium', 'High', 'Low'];
        })
        .getTrajectoryTypesForClient();

      google.script.run
        .withSuccessHandler(populatePlayerDropdowns)
        .withFailureHandler(showError)
        .getPlayerAttributeList();
    };

    function disableAllSelects() {
      var selects = ['player1', 'player2', 'player3', 'player4', 'player5'];
      selects.forEach(function(selectId) {
        var select = document.getElementById(selectId);
        select.disabled = true;
        select.innerHTML = '<option value="">Loading players...</option>';
      });
    }

    function populatePlayerDropdowns(players) {
      allPlayers = players;
      var selects = ['player1', 'player2', 'player3', 'player4', 'player5'];

      selects.forEach(function(selectId, index) {
        var select = document.getElementById(selectId);
        select.innerHTML = '<option value="">-- Select Player --</option>';

        players.forEach(function(player) {
          var option = document.createElement('option');
          option.value = player;
          option.textContent = player;
          select.appendChild(option);
        });

        // Enable player1, disable others until progressive selection
        select.disabled = (index > 0);

        // Add change listener for progressive enabling
        select.addEventListener('change', function() {
          updateProgressiveSelects();
        });
      });

      // Add search/filter functionality to each select
      addSelectFilter();
    }

    function updateProgressiveSelects() {
      var selects = ['player1', 'player2', 'player3', 'player4', 'player5'];

      for (var i = 1; i < selects.length; i++) {
        var prevSelect = document.getElementById(selects[i - 1]);
        var currSelect = document.getElementById(selects[i]);

        // Enable current select only if previous select has a value
        currSelect.disabled = !prevSelect.value;

        // Clear current select if it's being disabled
        if (currSelect.disabled && currSelect.value) {
          currSelect.value = '';
        }
      }
    }

    function addSelectFilter() {
      var selects = ['player1', 'player2', 'player3', 'player4', 'player5'];

      selects.forEach(function(selectId) {
        var select = document.getElementById(selectId);

        // Add keyboard search functionality
        var searchTerm = '';
        var searchTimeout;

        select.addEventListener('keydown', function(e) {
          // Clear previous timeout
          clearTimeout(searchTimeout);

          // Build search term
          if (e.key.length === 1) {
            searchTerm += e.key.toLowerCase();

            // Find matching option
            var options = Array.from(select.options);
            var match = options.find(function(opt) {
              return opt.textContent.toLowerCase().startsWith(searchTerm);
            });

            if (match) {
              select.value = match.value;
            }
          }

          // Clear search term after 1 second
          searchTimeout = setTimeout(function() {
            searchTerm = '';
          }, 1000);
        });
      });
    }

    // ===== CORE LOGIC & RENDERING =====

    function comparePlayers() {
      var player1 = document.getElementById('player1').value;
      var player2 = document.getElementById('player2').value;
      var player3 = document.getElementById('player3').value;
      var player4 = document.getElementById('player4').value;
      var player5 = document.getElementById('player5').value;

      // Get the exclude Miis checkbox value
      var excludeMiis = document.getElementById('excludeMiis').checked;

      // Allow single player selection
      if (!player1) {
        showError('Please select at least 1 player.');
        return;
      }

      var playerNames = [player1];
      if (player2) playerNames.push(player2);
      if (player3) playerNames.push(player3);
      if (player4) playerNames.push(player4);
      if (player5) playerNames.push(player5);

      // Check if single player selected - enable edit mode
      if (playerNames.length === 1) {
        editMode = true;
        currentEditingPlayer = player1;

        // Fetch league averages and player data for edit mode
        document.getElementById('results').innerHTML = '<div class="loading">Loading attributes and averages...</div>';

        // First fetch player data to get character class
        google.script.run
          .withSuccessHandler(function(stats) {
            if (stats && stats.length > 0) {
              var playerClass = stats[0].characterClass;

              // Now fetch both league and class averages in parallel
              var leaguePromise = new Promise(function(resolve, reject) {
                google.script.run
                  .withSuccessHandler(resolve)
                  .withFailureHandler(reject)
                  .getLeagueAverages(excludeMiis);
              });

              var classPromise = new Promise(function(resolve, reject) {
                google.script.run
                  .withSuccessHandler(resolve)
                  .withFailureHandler(reject)
                  .getClassAverages(playerClass, excludeMiis);
              });

              // Wait for both, then display
              Promise.all([leaguePromise, classPromise])
                .then(function(results) {
                  leagueAverages = results[0];
                  classAverages = results[1];
                  displayResults(stats);
                })
                .catch(showError);
            } else {
              showError('No data found for selected player.');
            }
          })
          .withFailureHandler(showError)
          .getPlayerAttributesWithAverages(playerNames);
      } else {
        editMode = false;
        currentEditingPlayer = null;
        leagueAverages = null;
        classAverages = null;

        document.getElementById('results').innerHTML = '<div class="loading">Loading attributes and calculating averages...</div>';

        google.script.run
          .withSuccessHandler(displayResults)
          .withFailureHandler(showError)
          .getPlayerAttributesWithAverages(playerNames);
      }
    }

    // ===== VALIDATION FUNCTIONS =====

    function validateField(fieldName, value) {
      var rule = VALIDATION_RULES[fieldName];
      if (!rule) return { valid: true }; // No validation rule, assume valid

      if (rule.type === 'number') {
        var num = Number(value);
        if (isNaN(num)) return { valid: false, error: 'Must be a number' };
        if (num < rule.min) return { valid: false, error: 'Min: ' + rule.min };
        if (num > rule.max) return { valid: false, error: 'Max: ' + rule.max };
        return { valid: true };
      }

      if (rule.type === 'dropdown') {
        if (!rule.options.includes(value)) {
          return { valid: false, error: 'Invalid option' };
        }
        return { valid: true };
      }

      return { valid: true };
    }

    function validateAndMarkField(input, fieldName) {
      var value = input.value;
      var result = validateField(fieldName, value);

      input.classList.remove('valid', 'invalid', 'modified');

      if (result.valid) {
        input.classList.add('valid');
        if (value !== String(originalData[fieldName])) {
          input.classList.add('modified');
          modifiedFields[fieldName] = value;
        } else {
          delete modifiedFields[fieldName];
        }

        // Remove error message if exists
        var errorDiv = input.nextElementSibling;
        if (errorDiv && errorDiv.classList.contains('validation-error')) {
          errorDiv.remove();
        }
      } else {
        input.classList.add('invalid');

        // Add/update error message
        var errorDiv = input.nextElementSibling;
        if (!errorDiv || !errorDiv.classList.contains('validation-error')) {
          errorDiv = document.createElement('span');
          errorDiv.className = 'validation-error';
          input.parentNode.insertBefore(errorDiv, input.nextSibling);
        }
        errorDiv.textContent = result.error;
      }

      // Update save button state
      updateSaveButtonState();
    }

    function validateAllFields() {
      var inputs = document.querySelectorAll('.stat-input');
      var allValid = true;

      inputs.forEach(function(input) {
        var fieldName = input.dataset.field;
        var result = validateField(fieldName, input.value);

        if (!result.valid) {
          allValid = false;
        }
      });

      return allValid;
    }

    function updateSaveButtonState() {
      var saveBtn = document.getElementById('saveBtn');
      if (!saveBtn) return;

      var hasModifications = Object.keys(modifiedFields).length > 0;
      var allValid = validateAllFields();

      saveBtn.disabled = !hasModifications || !allValid;
    }

    // ===== EDIT MODE FUNCTIONS =====

    // Generate HTML string for number input (no event listener yet)
    function generateNumberInputHTML(value, min, max, fieldName) {
      return '<input type="number" class="stat-input" value="' + value +
             '" min="' + min + '" max="' + max + '" data-field="' + fieldName + '">';
    }

    // Generate HTML string for dropdown input (no event listener yet)
    function generateDropdownInputHTML(value, options, fieldName) {
      var html = '<select class="stat-input" data-field="' + fieldName + '">';

      // Add blank option for optional fields (Mii Color can be blank)
      if (fieldName === 'Mii Color' && (!value || value === '')) {
        html += '<option value="" selected></option>';
      }

      options.forEach(function(opt) {
        var selected = (opt === value) ? ' selected' : '';
        html += '<option value="' + opt + '"' + selected + '>' + opt + '</option>';
      });
      html += '</select>';
      return html;
    }

    // Generate appropriate input HTML based on field type
    function renderStatCell(fieldName, value, isEditMode) {
      if (isEditMode) {
        var rule = VALIDATION_RULES[fieldName];
        if (rule && rule.type === 'number') {
          return generateNumberInputHTML(value, rule.min, rule.max, fieldName);
        } else if (rule && rule.type === 'dropdown') {
          return generateDropdownInputHTML(value, rule.options, fieldName);
        }
      }

      // Render as text (read-only or no validation rule)
      return (value !== undefined && value !== null ? value : '-');
    }

    // Attach event listeners to all inputs after HTML is rendered
    function attachInputListeners() {
      var inputs = document.querySelectorAll('.stat-input');
      inputs.forEach(function(input) {
        var fieldName = input.dataset.field;

        if (input.tagName === 'SELECT') {
          input.addEventListener('change', function() {
            validateAndMarkField(this, fieldName);
          });
        } else {
          input.addEventListener('input', function() {
            validateAndMarkField(this, fieldName);
          });
        }
      });
    }

    // Map field keys to league average keys
    var leagueAverageKeyMap = {
      'weight': 'weight',
      'pitchingOverall': 'pitchingOverall',
      'battingOverall': 'battingOverall',
      'fieldingOverall': 'fieldingOverall',
      'speedOverall': 'speedOverall',
      'fastballSpeed': 'fastballSpeed',
      'curveballSpeed': 'curveballSpeed',
      'curve': 'curve',
      'stamina': 'stamina',
      'slapHitContact': 'slapHitContact',
      'chargeHitContact': 'chargeHitContact',
      'slapHitPower': 'slapHitPower',
      'chargeHitPower': 'chargeHitPower',
      'fielding': 'fielding',
      'throwingSpeed': 'throwingSpeed',
      'speed': 'speed',
      'bunting': 'bunting',
      'pitchingAverage': 'pitchingAverage',
      'battingAverage': 'battingAverage',
      'fieldingAverage': 'fieldingAverage'
    };

    // Get league average for a stat key
    function getLeagueAverage(key) {
      if (!leagueAverages || !leagueAverageKeyMap[key]) return '-';
      return leagueAverages[leagueAverageKeyMap[key]] || '-';
    }

    // Get class average for a stat key
    function getClassAverage(key) {
      if (!classAverages || !leagueAverageKeyMap[key]) return '-';
      return classAverages[leagueAverageKeyMap[key]] || '-';
    }

    // Get validation range label for a field
    function getValidationRangeLabel(fieldLabel) {
      var rule = VALIDATION_RULES[fieldLabel];
      if (!rule) return '';

      if (rule.type === 'number') {
        return ' <span style="color: #5f6368; font-size: 11px; font-weight: normal;">(' + rule.min + '-' + rule.max + ')</span>';
      } else if (rule.type === 'dropdown') {
        // For dropdowns with 2-3 options, show them all
        if (rule.options.length <= 3) {
          return ' <span style="color: #5f6368; font-size: 11px; font-weight: normal;">(' + rule.options.join('/') + ')</span>';
        } else {
          // For dropdowns with many options, just indicate it's a dropdown
          return ' <span style="color: #5f6368; font-size: 11px; font-weight: normal;">(Dropdown)</span>';
        }
      }

      return '';
    }

    function displayResults(stats) {
      if (!stats || stats.length === 0) {
        showError('No data found for selected players.');
        return;
      }

      // Store original data if in edit mode
      if (editMode && stats.length === 1) {
        originalData = JSON.parse(JSON.stringify(stats[0])); // Deep copy
        modifiedFields = {};
      }

      var html = '';

      // Add edit mode indicator if editing single player
      if (editMode && stats.length === 1) {
        html += '<div class="edit-mode-indicator">';
        html += '‚úèÔ∏è EDIT MODE: Editing ' + stats[0].name + ' (' + stats[0].characterClass + ') | Changes highlighted in blue | Class & League averages shown';
        html += '</div>';
      }

      // Basic Info Section
      html += '<div class="stat-section">';
      html += '<h3>üìã Basic Information</h3>';
      html += '<table><thead><tr><th class="stat-label">Attribute</th>';

      stats.forEach(function(player) {
        html += '<th class="player-header">' + player.name + '</th>';
      });

      // Add class and league average columns in edit mode
      if (editMode && stats.length === 1) {
        if (classAverages) {
          html += '<th class="player-header league-header">Class Average</th>';
        }
        if (leagueAverages) {
          html += '<th class="player-header league-header">League Average</th>';
        }
      }

      html += '</tr></thead><tbody>';
      
      var basicInfo = [
        {label: 'Character Class', key: 'characterClass'},
        {label: 'Captain', key: 'captain'},
        {label: 'Mii', key: 'mii'},
        {label: 'Mii Color', key: 'miiColor'},
        {label: 'Throwing Side', key: 'armSide'},
        {label: 'Batting Side', key: 'battingSide'},
        {label: 'Weight', key: 'weight'},
        {label: 'Ability', key: 'ability'}
      ];
      
      basicInfo.forEach(function(info) {
        var labelWithRange = info.label;
        if (editMode && stats.length === 1) {
          labelWithRange += getValidationRangeLabel(info.label);
        }
        html += '<tr><td class="stat-label">' + labelWithRange + '</td>';
        stats.forEach(function(player, index) {
          var value = player[info.key];
          if (editMode && stats.length === 1 && index === 0) {
            html += '<td>' + renderStatCell(info.label, value, true) + '</td>';
          } else {
            html += '<td>' + (value !== undefined && value !== null ? value : '-') + '</td>';
          }
        });
        // Add class and league average columns in edit mode
        if (editMode && stats.length === 1) {
          if (classAverages) {
            html += '<td>' + getClassAverage(info.key) + '</td>';
          }
          if (leagueAverages) {
            html += '<td>' + getLeagueAverage(info.key) + '</td>';
          }
        }
        html += '</tr>';
      });
      
      html += '</tbody></table></div>';
      
      // Overall Stats Section
      html += '<div class="stat-section">';
      html += '<h3>‚≠ê Overall Ratings</h3>';
      html += '<table><thead><tr><th class="stat-label">Attribute</th>';

      stats.forEach(function(player) {
        html += '<th class="player-header">' + player.name + '</th>';
      });

      // Add class and league average columns in edit mode
      if (editMode && stats.length === 1) {
        if (classAverages) {
          html += '<th class="player-header league-header">Class Average</th>';
        }
        if (leagueAverages) {
          html += '<th class="player-header league-header">League Average</th>';
        }
      }

      html += '</tr></thead><tbody>';
      
      var overallStats = [
        {label: 'Pitching Overall', key: 'pitchingOverall'},
        {label: 'Batting Overall', key: 'battingOverall'},
        {label: 'Fielding Overall', key: 'fieldingOverall'},
        {label: 'Speed Overall', key: 'speedOverall'}
      ];
      
      overallStats.forEach(function(stat) {
        var labelWithRange = stat.label;
        if (editMode && stats.length === 1) {
          labelWithRange += getValidationRangeLabel(stat.label);
        }
        html += '<tr class="overall-row"><td class="stat-label">' + labelWithRange + '</td>';
        var values = stats.map(function(p) { return p[stat.key]; });
        var maxValue = Math.max.apply(null, values);

        stats.forEach(function(player, index) {
          var value = player[stat.key];
          if (editMode && stats.length === 1 && index === 0) {
            html += '<td>' + renderStatCell(stat.label, value, true) + '</td>';
          } else {
            var cellClass = (value === maxValue && maxValue > 0) ? ' class="best-value"' : '';
            html += '<td' + cellClass + '>' + (value !== undefined && value !== null ? value : '-') + '</td>';
          }
        });
        // Add class and league average in edit mode
        if (editMode && stats.length === 1) {
          if (classAverages) {
            html += '<td>' + getClassAverage(stat.key) + '</td>';
          }
          if (leagueAverages) {
            html += '<td>' + getLeagueAverage(stat.key) + '</td>';
          }
        }
        html += '</tr>';
      });

      html += '<tr class="average-row"><td class="stat-label">Overall Average</td>';
      stats.forEach(function(player) {
        var avg = (player.pitchingOverall + player.battingOverall + player.fieldingOverall + player.speedOverall) / 4;
        html += '<td>' + avg.toFixed(2) + '</td>';
      });
      // Add class and league averages for Overall Average in edit mode
      if (editMode && stats.length === 1) {
        if (classAverages) {
          var classOverallAvg = (
            parseFloat(classAverages.pitchingOverall) +
            parseFloat(classAverages.battingOverall) +
            parseFloat(classAverages.fieldingOverall) +
            parseFloat(classAverages.speedOverall)
          ) / 4;
          html += '<td>' + classOverallAvg.toFixed(2) + '</td>';
        }
        if (leagueAverages) {
          var leagueOverallAvg = (
            parseFloat(leagueAverages.pitchingOverall) +
            parseFloat(leagueAverages.battingOverall) +
            parseFloat(leagueAverages.fieldingOverall) +
            parseFloat(leagueAverages.speedOverall)
          ) / 4;
          html += '<td>' + leagueOverallAvg.toFixed(2) + '</td>';
        }
      }
      html += '</tr>';

      html += '</tbody></table></div>';
      
      // Pitching Attributes
      html += '<div class="stat-section">';
      html += '<h3>‚öæ Pitching Attributes</h3>';
      html += '<table><thead><tr><th class="stat-label">Attribute</th>';

      stats.forEach(function(player) {
        html += '<th class="player-header">' + player.name + '</th>';
      });

      // Add class and league average columns in edit mode
      if (editMode && stats.length === 1) {
        if (classAverages) {
          html += '<th class="player-header league-header">Class Average</th>';
        }
        if (leagueAverages) {
          html += '<th class="player-header league-header">League Average</th>';
        }
      }

      html += '</tr></thead><tbody>';
      
      // Add Pitching Overall at top of section
      html += '<tr class="category-overall"><td class="stat-label">Pitching Overall</td>';
      var pitchingValues = stats.map(function(p) { return p.pitchingOverall; });
      var maxPitchingValue = Math.max.apply(null, pitchingValues);

      stats.forEach(function(player, index) {
        var value = player.pitchingOverall;
        var cellClass = (value === maxPitchingValue && maxPitchingValue > 0) ? ' class="best-value"' : '';
        html += '<td' + cellClass + '>' + (value !== undefined && value !== null ? value : '-') + '</td>';
      });
      if (editMode && stats.length === 1) {
        if (classAverages) {
          html += '<td>' + getClassAverage('pitchingOverall') + '</td>';
        }
        if (leagueAverages) {
          html += '<td>' + getLeagueAverage('pitchingOverall') + '</td>';
        }
      }
      html += '</tr>';

      var pitchingStats = [
        {label: 'Pre-Charge', key: 'preCharge', isEditable: true},  // Custom field, editable dropdown
        {label: 'Star Pitch', key: 'starPitch', isEditable: true},   // Editable dropdown
        {label: 'Fastball Speed', key: 'fastballSpeed'},
        {label: 'Curveball Speed', key: 'curveballSpeed'},
        {label: 'Curve', key: 'curve'},
        {label: 'Stamina', key: 'stamina'}
      ];

      pitchingStats.forEach(function(stat) {
        var labelWithRange = stat.label;
        if (editMode && stats.length === 1) {
          labelWithRange += getValidationRangeLabel(stat.label);
        }
        html += '<tr><td class="stat-label">' + labelWithRange + '</td>';

        if (stat.isEditable) {
          // Editable text field (dropdown)
          stats.forEach(function(player, index) {
            var value = player[stat.key];
            if (editMode && stats.length === 1 && index === 0) {
              html += '<td>' + renderStatCell(stat.label, value, true) + '</td>';
            } else {
              html += '<td>' + (value !== undefined && value !== null ? value : '-') + '</td>';
            }
          });
          if (editMode && stats.length === 1) {
            if (classAverages) {
              html += '<td>-</td>';
            }
            if (leagueAverages) {
              html += '<td>-</td>';
            }
          }
        } else {
          // Numeric value, highlight best, allow editing
          var values = stats.map(function(p) { return p[stat.key]; });
          var maxValue = Math.max.apply(null, values);

          stats.forEach(function(player, index) {
            var value = player[stat.key];
            if (editMode && stats.length === 1 && index === 0) {
              html += '<td>' + renderStatCell(stat.label, value, true) + '</td>';
            } else {
              var cellClass = (value === maxValue && maxValue > 0) ? ' class="best-value"' : '';
              html += '<td' + cellClass + '>' + (value !== undefined && value !== null ? value : '-') + '</td>';
            }
          });
          if (editMode && stats.length === 1) {
            if (classAverages) {
              html += '<td>' + getClassAverage(stat.key) + '</td>';
            }
            if (leagueAverages) {
              html += '<td>' + getLeagueAverage(stat.key) + '</td>';
            }
          }
        }
        html += '</tr>';
      });

      // Add Pitching Average row
      html += '<tr class="average-row"><td class="stat-label">Pitching Average</td>';
      stats.forEach(function(player) {
        var avg = player.pitchingAverage;
        html += '<td>' + (avg !== undefined && avg !== null ? avg.toFixed(2) : '-') + '</td>';
      });
      if (editMode && stats.length === 1) {
        if (classAverages) {
          html += '<td>' + getClassAverage('pitchingAverage') + '</td>';
        }
        if (leagueAverages) {
          html += '<td>' + getLeagueAverage('pitchingAverage') + '</td>';
        }
      }
      html += '</tr>';
      
      html += '</tbody></table></div>';
      
      // Batting/Hitting Attributes
      html += '<div class="stat-section">';
      html += '<h3>üèè Batting Attributes</h3>';
      html += '<table><thead><tr><th class="stat-label">Attribute</th>';

      stats.forEach(function(player) {
        html += '<th class="player-header">' + player.name + '</th>';
      });

      // Add class and league average columns in edit mode
      if (editMode && stats.length === 1) {
        if (classAverages) {
          html += '<th class="player-header league-header">Class Average</th>';
        }
        if (leagueAverages) {
          html += '<th class="player-header league-header">League Average</th>';
        }
      }

      html += '</tr></thead><tbody>';

      // Add Batting Overall at top of section
      html += '<tr class="category-overall"><td class="stat-label">Batting Overall</td>';
      var battingValues = stats.map(function(p) { return p.battingOverall; });
      var maxBattingValue = Math.max.apply(null, battingValues);

      stats.forEach(function(player, index) {
        var value = player.battingOverall;
        var cellClass = (value === maxBattingValue && maxBattingValue > 0) ? ' class="best-value"' : '';
        html += '<td' + cellClass + '>' + (value !== undefined && value !== null ? value : '-') + '</td>';
      });
      if (editMode && stats.length === 1) {
        if (classAverages) {
          html += '<td>' + getClassAverage('battingOverall') + '</td>';
        }
        if (leagueAverages) {
          html += '<td>' + getLeagueAverage('battingOverall') + '</td>';
        }
      }
      html += '</tr>';
      
      var hittingStats = [
        {label: 'Star Swing', key: 'starSwing', isEditable: true},         // Editable dropdown
        {label: 'Hit Curve', key: 'hitCurve', isEditable: true},           // Editable dropdown
        {label: 'Hitting Trajectory', key: 'hittingTrajectory', isEditable: true}, // Editable dropdown
        {label: 'Slap Hit Contact Size', key: 'slapHitContact'},
        {label: 'Charge Hit Contact Size', key: 'chargeHitContact'},
        {label: 'Slap Hit Power', key: 'slapHitPower'},
        {label: 'Charge Hit Power', key: 'chargeHitPower'}
        // Pre-Charge moved to Pitching section
      ];

      hittingStats.forEach(function(stat) {
        var labelWithRange = stat.label;
        if (editMode && stats.length === 1) {
          labelWithRange += getValidationRangeLabel(stat.label);
        }
        html += '<tr><td class="stat-label">' + labelWithRange + '</td>';

        if (stat.isEditable) {
          // Editable text field (dropdown)
          stats.forEach(function(player, index) {
            var value = player[stat.key];
            if (editMode && stats.length === 1 && index === 0) {
              html += '<td>' + renderStatCell(stat.label, value, true) + '</td>';
            } else {
              html += '<td>' + (value !== undefined && value !== null ? value : '-') + '</td>';
            }
          });
          if (editMode && stats.length === 1) {
            if (classAverages) {
              html += '<td>-</td>';
            }
            if (leagueAverages) {
              html += '<td>-</td>';
            }
          }
        } else {
          // Numeric values, highlight best, allow editing
          var values = stats.map(function(p) { return p[stat.key]; });
          var maxValue = Math.max.apply(null, values);

          stats.forEach(function(player, index) {
            var value = player[stat.key];
            if (editMode && stats.length === 1 && index === 0) {
              html += '<td>' + renderStatCell(stat.label, value, true) + '</td>';
            } else {
              var cellClass = (value === maxValue && maxValue > 0) ? ' class="best-value"' : '';
              html += '<td' + cellClass + '>' + (value !== undefined && value !== null ? value : '-') + '</td>';
            }
          });
          if (editMode && stats.length === 1) {
            if (classAverages) {
              html += '<td>' + getClassAverage(stat.key) + '</td>';
            }
            if (leagueAverages) {
              html += '<td>' + getLeagueAverage(stat.key) + '</td>';
            }
          }
        }
        html += '</tr>';
      });

      // Add Batting Average row
      html += '<tr class="average-row"><td class="stat-label">Batting Average</td>';
      stats.forEach(function(player) {
        var avg = player.battingAverage;
        html += '<td>' + (avg !== undefined && avg !== null ? avg.toFixed(2) : '-') + '</td>';
      });
      if (editMode && stats.length === 1) {
        if (classAverages) {
          html += '<td>' + getClassAverage('battingAverage') + '</td>';
        }
        if (leagueAverages) {
          html += '<td>' + getLeagueAverage('battingAverage') + '</td>';
        }
      }
      html += '</tr>';
      
      html += '</tbody></table></div>';
      
      // Fielding Attributes
      html += '<div class="stat-section">';
      html += '<h3>üß§ Fielding Attributes</h3>';
      html += '<table><thead><tr><th class="stat-label">Attribute</th>';

      stats.forEach(function(player) {
        html += '<th class="player-header">' + player.name + '</th>';
      });

      // Add class and league average columns in edit mode
      if (editMode && stats.length === 1) {
        if (classAverages) {
          html += '<th class="player-header league-header">Class Average</th>';
        }
        if (leagueAverages) {
          html += '<th class="player-header league-header">League Average</th>';
        }
      }

      html += '</tr></thead><tbody>';

      // Add Fielding Overall at top of section
      html += '<tr class="category-overall"><td class="stat-label">Fielding Overall</td>';
      var fieldingValues = stats.map(function(p) { return p.fieldingOverall; });
      var maxFieldingValue = Math.max.apply(null, fieldingValues);

      stats.forEach(function(player, index) {
        var value = player.fieldingOverall;
        var cellClass = (value === maxFieldingValue && maxFieldingValue > 0) ? ' class="best-value"' : '';
        html += '<td' + cellClass + '>' + (value !== undefined && value !== null ? value : '-') + '</td>';
      });
      if (editMode && stats.length === 1) {
        if (classAverages) {
          html += '<td>' + getClassAverage('fieldingOverall') + '</td>';
        }
        if (leagueAverages) {
          html += '<td>' + getLeagueAverage('fieldingOverall') + '</td>';
        }
      }
      html += '</tr>';

      var fieldingStats = [
        {label: 'Fielding', key: 'fielding'},
        {label: 'Throwing Speed', key: 'throwingSpeed'}
      ];

      fieldingStats.forEach(function(stat) {
        var labelWithRange = stat.label;
        if (editMode && stats.length === 1) {
          labelWithRange += getValidationRangeLabel(stat.label);
        }
        html += '<tr><td class="stat-label">' + labelWithRange + '</td>';
        var values = stats.map(function(p) { return p[stat.key]; });
        var maxValue = Math.max.apply(null, values);

        stats.forEach(function(player, index) {
          var value = player[stat.key];
          if (editMode && stats.length === 1 && index === 0) {
            html += '<td>' + renderStatCell(stat.label, value, true) + '</td>';
          } else {
            var cellClass = (value === maxValue && maxValue > 0) ? ' class="best-value"' : '';
            html += '<td' + cellClass + '>' + (value !== undefined && value !== null ? value : '-') + '</td>';
          }
        });
        if (editMode && stats.length === 1) {
          if (classAverages) {
            html += '<td>' + getClassAverage(stat.key) + '</td>';
          }
          if (leagueAverages) {
            html += '<td>' + getLeagueAverage(stat.key) + '</td>';
          }
        }
        html += '</tr>';
      });

      // Add Fielding Average row
      html += '<tr class="average-row"><td class="stat-label">Fielding Average</td>';
      stats.forEach(function(player) {
        var avg = player.fieldingAverage;
        html += '<td>' + (avg !== undefined && avg !== null ? avg.toFixed(2) : '-') + '</td>';
      });
      if (editMode && stats.length === 1) {
        if (classAverages) {
          html += '<td>' + getClassAverage('fieldingAverage') + '</td>';
        }
        if (leagueAverages) {
          html += '<td>' + getLeagueAverage('fieldingAverage') + '</td>';
        }
      }
      html += '</tr>';
      
      html += '</tbody></table></div>';
      
      // Running Attributes
      html += '<div class="stat-section">';
      html += '<h3>üèÉ Running Attributes</h3>';
      html += '<table><thead><tr><th class="stat-label">Attribute</th>';

      stats.forEach(function(player) {
        html += '<th class="player-header">' + player.name + '</th>';
      });

      // Add class and league average columns in edit mode
      if (editMode && stats.length === 1) {
        if (classAverages) {
          html += '<th class="player-header league-header">Class Average</th>';
        }
        if (leagueAverages) {
          html += '<th class="player-header league-header">League Average</th>';
        }
      }

      html += '</tr></thead><tbody>';

      // Add Speed Overall at top of section
      html += '<tr class="category-overall"><td class="stat-label">Speed Overall</td>';
      var speedOverallValues = stats.map(function(p) { return p.speedOverall; });
      var maxSpeedOverall = Math.max.apply(null, speedOverallValues);

      stats.forEach(function(player, index) {
        var value = player.speedOverall;
        var cellClass = (value === maxSpeedOverall && maxSpeedOverall > 0) ? ' class="best-value"' : '';
        html += '<td' + cellClass + '>' + (value !== undefined && value !== null ? value : '-') + '</td>';
      });
      if (editMode && stats.length === 1) {
        if (classAverages) {
          html += '<td>' + getClassAverage('speedOverall') + '</td>';
        }
        if (leagueAverages) {
          html += '<td>' + getLeagueAverage('speedOverall') + '</td>';
        }
      }
      html += '</tr>';

      var speedLabel = 'Speed';
      if (editMode && stats.length === 1) {
        speedLabel += getValidationRangeLabel('Speed');
      }
      html += '<tr><td class="stat-label">' + speedLabel + '</td>';
      var speedValues = stats.map(function(p) { return p.speed; });
      var maxSpeed = Math.max.apply(null, speedValues);

      stats.forEach(function(player, index) {
        var value = player.speed;
        if (editMode && stats.length === 1 && index === 0) {
          html += '<td>' + renderStatCell('Speed', value, true) + '</td>';
        } else {
          var cellClass = (value === maxSpeed && maxSpeed > 0) ? ' class="best-value"' : '';
          html += '<td' + cellClass + '>' + (value !== undefined && value !== null ? value : '-') + '</td>';
        }
      });
      if (editMode && stats.length === 1) {
        if (classAverages) {
          html += '<td>' + getClassAverage('speed') + '</td>';
        }
        if (leagueAverages) {
          html += '<td>' + getLeagueAverage('speed') + '</td>';
        }
      }
      html += '</tr>';

      var buntingLabel = 'Bunting';
      if (editMode && stats.length === 1) {
        buntingLabel += getValidationRangeLabel('Bunting');
      }
      html += '<tr><td class="stat-label">' + buntingLabel + '</td>';
      var buntingValues = stats.map(function(p) { return p.bunting; });
      var maxBunting = Math.max.apply(null, buntingValues);

      stats.forEach(function(player, index) {
        var value = player.bunting;
        if (editMode && stats.length === 1 && index === 0) {
          html += '<td>' + renderStatCell('Bunting', value, true) + '</td>';
        } else {
          var cellClass = (value === maxBunting && maxBunting > 0) ? ' class="best-value"' : '';
          html += '<td' + cellClass + '>' + (value !== undefined && value !== null ? value : '-') + '</td>';
        }
      });
      if (editMode && stats.length === 1) {
        if (classAverages) {
          html += '<td>' + getClassAverage('bunting') + '</td>';
        }
        if (leagueAverages) {
          html += '<td>' + getLeagueAverage('bunting') + '</td>';
        }
      }
      html += '</tr>';
      
      html += '</tbody></table></div>';

      // Add edit action buttons if in edit mode
      if (editMode && stats.length === 1) {
        html += '<div class="edit-actions">';
        html += '  <button id="saveBtn" class="save-btn" onclick="saveChanges()" disabled>';
        html += '    üíæ Save Changes';
        html += '  </button>';
        html += '  <button class="reset-btn" onclick="resetFields()">';
        html += '    üîÑ Reset to Original';
        html += '  </button>';
        html += '  <button class="cancel-btn" onclick="cancelEdit()">';
        html += '    ‚ùå Cancel';
        html += '  </button>';
        html += '  <div class="edit-help">';
        html += '    üí° Tip: Modified fields show in blue, invalid fields in red';
        html += '  </div>';
        html += '</div>';
      }

      document.getElementById('results').innerHTML = html;

      // Attach event listeners to all inputs after DOM is updated
      if (editMode && stats.length === 1) {
        attachInputListeners();
      }
    }

    // ===== EDIT ACTION HANDLERS =====

    function saveChanges() {
      // Validate all fields
      if (!validateAllFields()) {
        showDialog('Validation Error', 'Please fix all invalid fields before saving.');
        return;
      }

      // Check if there are any changes
      if (Object.keys(modifiedFields).length === 0) {
        showDialog('No Changes', 'No changes to save.');
        return;
      }

      // Disable save button and show loading state
      var saveBtn = document.getElementById('saveBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'üíæ Saving...';

      // Call server-side function to save changes
      google.script.run
        .withSuccessHandler(function(result) {
          showDialog('Success', 'Changes saved successfully!');
          // Reset edit mode
          editMode = false;
          currentEditingPlayer = null;
          modifiedFields = {};
          originalData = {};
          // Refresh the view
          clearSelection();
        })
        .withFailureHandler(function(error) {
          showDialog('Save Failed', 'Failed to save changes: ' + error);
          // Re-enable save button
          saveBtn.disabled = false;
          saveBtn.textContent = 'üíæ Save Changes';
        })
        .saveCharacterAttributes(currentEditingPlayer, modifiedFields);
    }

    function resetFields() {
      // Reset all input fields to original values
      var inputs = document.querySelectorAll('.stat-input');
      inputs.forEach(function(input) {
        var fieldName = input.dataset.field;
        var originalValue = originalData[fieldName];
        input.value = originalValue;
        validateAndMarkField(input, fieldName);
      });

      // Clear modified fields
      modifiedFields = {};
      updateSaveButtonState();
    }

    function cancelEdit() {
      // Confirm if there are unsaved changes
      if (Object.keys(modifiedFields).length > 0) {
        if (!confirm('You have unsaved changes. Are you sure you want to cancel?')) {
          return;
        }
      }

      // Reset edit mode
      editMode = false;
      currentEditingPlayer = null;
      modifiedFields = {};
      originalData = {};

      // Clear the view
      clearSelection();
    }

    function showDialog(title, message) {
      document.getElementById('dialogTitle').textContent = title;
      document.getElementById('dialogMessage').textContent = message;
      document.getElementById('dialogButtons').innerHTML = '<button class="dialog-btn primary" onclick="hideDialog()">OK</button>';
      document.getElementById('dialogOverlay').classList.add('show');
    }

    function hideDialog() {
      document.getElementById('dialogOverlay').classList.remove('show');
    }

    function clearSelection() {
      document.getElementById('player1').value = '';
      document.getElementById('player2').value = '';
      document.getElementById('player3').value = '';
      document.getElementById('player4').value = '';
      document.getElementById('player5').value = '';
      document.getElementById('results').innerHTML = '';
      // Reset progressive enabling
      updateProgressiveSelects();
    }
    
    function showError(error) {
      document.getElementById('results').innerHTML =
        '<div class="error">‚ö†Ô∏è Error: ' + error + '</div>';
    }
  </script>

  <!-- Dialog Overlay -->
  <div id="dialogOverlay" class="dialog-overlay">
    <div class="dialog-box">
      <div class="dialog-title" id="dialogTitle">Dialog Title</div>
      <div class="dialog-message" id="dialogMessage">Dialog message goes here.</div>
      <div class="dialog-buttons" id="dialogButtons">
        <button class="dialog-btn primary" onclick="hideDialog()">OK</button>
      </div>
    </div>
  </div>
</body>
</html>